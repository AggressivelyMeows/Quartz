{% macro tag_list(tags, column=False) %}
<style>
    .is-columned {
        display: flex;
        flex-flow: column;
    }
</style>
    {% for tag in tags %}
    {% with tag = db.get_tag(tag, search_by="tagID") %}
    {% if tag %}
<div class="control {% if column %}is-columned{% endif %}">
    <div class="tags has-addons" onclick="add_tag('{{tag.name}}')">
        {% if user %}
        {% if db.check_tag_like(tag.tagID, user.userID) %}
        <a class="tag is-success" onclick="unlike_tag('{{tag.tagID}}')">
            <i class="fas fa-star"></i>
        </a>
        {% else %}
        <a class="tag is-info" onclick="like_tag('{{tag.tagID}}')">
            <i class="fas fa-thumbs-up"></i>
        </a>
        {% endif %}
        {% endif %}
        <span class="tag is-dark">{{tag.type}}</span>
        {% if tag.type == 'fandom' %}
        <span class="tag is-info">{{tag.name}}</span>
        {% endif %}
        {% if tag.type == 'character' %}
        <span class="tag is-danger">{{tag.name}} {% if tag.fandom %} ({{tag.fandom}}){% endif %}</span>
        {% endif %}
        {% if tag.type == 'kink' %}
        <span class="tag is-warning">{{tag.name}}</span>
        {% endif %}
        {% if tag.type == 'author' %}
        <span class="tag is-success">{{tag.name}}</span>
        {% endif %}
    </div>
</div>
    {% endif %}
    {% endwith %}
    {% endfor %}

{% endmacro %}
{% macro tag_solo(tag, column=False) %}
<div class="control {% if column %}is-columned{% endif %}">
    <div class="tags has-addons" onclick="add_tag('{{tag.name}}')" style="margin-bottom:0px;">
        {% if user %}
        {% if db.check_tag_like(tag.tagID, user.userID) %}
        <a class="tag is-success" onclick="unlike_tag('{{tag.tagID}}')">
            <i class="fas fa-star"></i>
        </a>
        {% else %}
        <a class="tag is-info" onclick="like_tag('{{tag.tagID}}')">
            <i class="fas fa-thumbs-up"></i>
        </a>
        {% endif %}
        {% endif %}
        <span class="tag is-dark">{{tag.type}}</span>
        {% if tag.type == 'fandom' %}
        <span class="tag is-info">{{tag.name}}</span>
        {% endif %}
        {% if tag.type == 'character' %}
        <span class="tag is-danger">{{tag.name}} {% if tag.fandom %} ({{tag.fandom}}){% endif %}</span>
        {% endif %}
        {% if tag.type == 'kink' %}
        <span class="tag is-warning">{{tag.name}}</span>
        {% endif %}
        {% if tag.type == 'author' %}
        <span class="tag is-success">{{tag.name}}</span>
        {% endif %}
    </div>
</div>
{% endmacro %}
{% macro search_bar(tags) %}
<div class="field has-addons">
    <div class="control is-expanded ">
        {% if tags %}
        <input class="input" type="text" placeholder="Search by tag" id="search_bar" value="{% for tagID in tags %}{% with tag = get_tag(tagID) %}{{tag.name}} {%endwith%}{%endfor%}">
        {% else %}
        <input class="input" type="text" placeholder="Search by tag" id="search_bar" value="">
        {% endif %}
    </div>
    <div class="control">
        <a class="button is-info" id="search">
            Search
        </a>
    </div>
</div>
<script>
    function search() {
        var query = $('#search_bar').val().split(" ");
        console.log(query)
        var url = '/search?tags=' + query.join('+');
        window.location = url;
    }
    $('#search').click(function () {
        search();
    })
    $('#search_bar').keyup(function (e) {
        if (e.keyCode == 13) {
            search();
        }
    });
</script>
{% endmacro %}
<head>
    {% if dark_mode == 'on' %}
    <link href="/static/css/framework.min.css" rel="stylesheet" />
    {% else %}
    <link href="https://jenil.github.io/bulmaswatch/lumen/bulmaswatch.min.css" rel="stylesheet" />
    {% endif %}

    <link href="https://use.fontawesome.com/releases/v5.0.7/css/all.css" rel="stylesheet" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="/static/js/cookie_manager.js"></script>
    {% block head %}
    {% endblock %}
    {% block meta %}
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@Quartz_" />
    <meta name="twitter:title" content="Quartz" />
    <meta name="twitter:description" content="Quartz. The next generation image board" />
    <meta name="twitter:image" content="https://cdn.discordapp.com/attachments/307615051689361408/480842001411997696/Screen_Shot_2018-08-19_at_01.00.48.png" />
    {% endblock %}
</head>
<body>
    <style>
        .no-show {
            display: none;
        }

        .image_container {
            display: flex;
            flex-flow: wrap;
        }

        .image_container > img {
            margin: 10px;
            font-size: 0px;
            cursor: pointer;
            height: 200px;
            width: auto;
        }

        html body {
            width: 100%;
            height: 100%;
        }
    </style>
    <script>
        function open_image(imageID) {
            window.location = '/image/' + imageID;
        }
        function show_notification(notif_text, category) {
            // reset to normals
            $('#top_notif').attr('class', 'notification no-show');
            $('#top_notif').addClass(category);
            $('#top_notif > .text').text(notif_text);
            $('#top_notif').toggleClass('no-show');

            setTimeout(function () {
                $('#top_notif').attr('class', 'notification no-show');
            }, 4000)
        }
        $(document).ready(function () {

            // Check for click events on the navbar burger icon
            $(".navbar-burger").click(function () {

                // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
                $(".navbar-burger").toggleClass("is-active");
                $(".navbar-menu").toggleClass("is-active");

            });
            function search() {
                var query = $('#search_bar').val().split(" ");
                console.log(query)
                var url = '/search?tags=' + query.join('+');
                window.location = url;
            }
            $('#search').click(function () {
                search();
            })
            $('#search_bar').keyup(function (e) {
                if (e.keyCode == 13) {
                    search();
                }
            });
        });
        function add_tag(tag_name) {
            if ($('#search_bar').val()) {
                $('#search_bar').val($('#search_bar').val() + ' ' + tag_name)
            } else {
                $('#search_bar').val(tag_name)
            }

        }
        function toggle_nsfw() {
            cookie_manager = new CookieManager();

            if (cookie_manager.get('enable_nsfw') == '1') {
                cookie_manager.set('enable_nsfw', '0', 14);
                $('.blur_overlay').css('filter', 'blur(5px)');
            } else {
                cookie_manager.set('enable_nsfw', '1', 14);
                $('.blur_overlay').css('filter', '');
            }
            
        }
    </script>

    <!-- Nav bar -->
    {% block nav %}
    <nav class="navbar is-info is-large is-transparent" style="">
        <div class="container">
            <div class="navbar-brand">
                <a class="navbar-item" href="/">
                    <img src="/static/logo/new/logo_white.png" style="max-height:36px;"/>
                    <span style="font-size:1.3em;margin-left:5px;">QuartzBoard</span>
                </a>
                <div class="navbar-burger burger" data-target="navbarExampleTransparentExample">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>

            <div id="navbarExampleTransparentExample" class="navbar-menu">
                <div class="navbar-start">
                    <a class="navbar-item" href="/search">
                        Search
                    </a>
                    <a class="navbar-item" href="/stats">
                        Stats
                    </a>
                </div>

                <div class="navbar-end">
                    <div class="navbar-item">
                        {% if is_logged_in %}
                        <div class="field is-grouped">
                            <p class="control" style="display:flex;align-items:center;justify-content:center;">
                                <a class="" href="https://www.patreon.com/quartz_"><img src="https://bulma.io/images/become-a-patron.png" /></a>
                            </p>
                            <p class="control">
                                <a class="button" href="/profile">{{user.username}}</a>
                            </p>
                            <p class="control">
                                <a class="button" href="/profile/upload">Upload</a>
                            </p>
                        </div>
                        {% else %}
                        <div class="field is-grouped">
                            <p class="control" style="display:flex;align-items:center;justify-content:center;">
                                <a class="" href="https://www.patreon.com/quartz_"><img src="https://bulma.io/images/become-a-patron.png" /></a>
                            </p>
                            <p class="control">
                                <a class="button" href="/login">Login</a>
                            </p>
                            <p class="control">
                                <a class="button is-primary" href="/create">
                                    <span>Sign up</span>
                                </a>
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </nav>
    {% endblock %}
    <div class="columns" style="margin:0 2em;">
        {% block sidebar %}
        <div class="column is-3">
            {{search_bar(tags)}}
            <hr />
            <h1 class="subtitle is-4" style="">Most popular tags</h1>
            {% with tags = get_popular_tags(limit=7) %}
            {% for tag in tags %}
            {% if tag %}
            {{tag_solo(tag, column=True)}}
            {% endif %} 
            {% endfor %}
            {% endwith %}

            <br />
            <br />
            {% if dark_mode == 'on' %}
            <a href="/ui_mode?mode=light">Switch to light mode</a>
            {% else %}
            <a href="/ui_mode?mode=dark">Switch to dark mode</a>
            {% endif %}
            <hr />
        </div>
        {% endblock %}
        <div class="column">

            <div class="notification no-show" id="top_notif">
                <span class="text"></span>
            </div>
            {% if request.args.get('confirmed') %}
            <div class="notification is-success">
                Thank you for confirming your age.
            </div>
            {% endif %}
            {% if request.args.get('new_user') %}
            <div class="notification is-success">
                Welcome to Quartz. If you are new here, please read our <a>quick start guide</a>
            </div>
            {% endif %}
            {% if request.args.get('logged_in') %}
            <div class="notification is-success">
                Welcome back, {{user.username}}
            </div>
            {% endif %}

            <!-- Now for the flashed messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="notification {{ category }}">{{ message }}</div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            <!-- MAIN BODY -->
            {% block content %}
            {% endblock %}
        </div>
    </div>


</body>