{% extends 'imports.html' %}
{% block head %}

{% endblock %}
{% block sidebar %}
<script>
    function toggle_tab(tab_name) {
        $('.tab').removeClass('is-active')
        var tab = $('.tab[data-tab=' + tab_name + ']');
        tab.toggleClass('is-active');
    }
</script>
<div class="column is-2">
    <aside class="menu">
        <p class="menu-label">
            General
        </p>
        <ul class="menu-list">
            <li onclick="toggle_tab('dash_main')"><a class="tab is-active" data-tab="dash_main">Dashboard</a></li>
            <li onclick="toggle_tab('dash_settings')"><a class="tab" data-tab="dash_settings">Settings</a></li>
        </ul>
        <p class="menu-label">
            Management
        </p>
        <ul class="menu-list">
            <li onclick="toggle_tab('dash_images')"><a class="tab" data-tab="dash_images">Images</a></li>
        </ul>
        <p class="menu-label">
            Admin
        </p>
        <ul class="menu-list">
            <li onclick="toggle_tab('dash_permissions')"><a class="tab" data-tab="dash_permissions">Your Permissions</a></li>
            {% if user.role.has('edit_roles') %}
            <li><a class="tab" href="/admin/roles">Manage Roles</a></li>
            {% endif %}
        </ul>
    </aside>
</div>
{% endblock %}
{% block content %}
<style>
    .tab {
        display:none;
    }
    .tab.is-active {
        display:block
    }
</style>
<div class="box" style="display:flex;">
    <img style="border-radius:8px;height:64px;margin-right:1em;" src="/profile/{{user.userID}}/avatar">
    <div style="display:flex;justify-content:center;flex-flow:column">
        <h1 class="title is-4">
            Hey, {{user.username}}
        </h1>
        <h4 class="subtitle is-6">{{user.role.name}}</h4>
    </div>
</div>
<div class="box">
    <div class="tab is-active" data-tab="dash_main">
        <div class="columns">
            <div class="column">
                <p>This is your dashboard. Here is where you can see your images as well as edit some of the settings</p>
                
            </div>
            <div class="column">
                <div class="notification is-dark" style="display:flex;justify-content:center;align-items:center;flex-flow:column">
                    <span style="font-size:3.2em;">{{db.get_author_views(user.userID)}}</span><br /><span style="font-size:1.2em;">Total Views</span>
                </div>
            </div>
        </div>
    </div>
    <div class="tab" data-tab="dash_permissions">
        <p>Here are your permissions. If you wish to have a special role that enables you to do an action, please contact the site owner/moderation team inorder to get a role</p>
        <p><b>Your current role: {{user.role.name}}</b></p>
        <div class="" style="">
            {% for perm_name, perm_value in user.role.permissions.items() %}
            <span class="tag {%if perm_value%}is-success{%else%}is-danger{%endif%} is-medium">{{perm_name|replace('_', ' ')|title}}</span><br />
            
            {% endfor %}
        </div>
    </div>
    <div class="tab" data-tab="dash_images">
        <script>
            function delete_image(fileID) {
                var url = '/api/image/' + fileID + '/delete';
                $.ajax({
                    url: url
                }).done(function (resp) {
                    if (resp['success']) {
                        show_notification(resp['msg'], 'is-success')
                    } else {
                        show_notification(resp['msg'], 'is-danger')
                    }

                })
            }
        </script>
        {% with user_images = get_images(author=g.user['userID']) %}
        {% if not user_images %}
        <h1 class="subtitle is-5">Sorry, but you do not have any images uploaded</h1>
        <a class="button" href="/profile/upload">Upload</a>
        {% else %}
        {% for image in user_images %}
        <div class="" style="display:flex;flex-flow:row">
            <img class="image" onclick="open_image('{{image.fileID}}')" src="/api/image/{{image.fileID}}/thumbnail" style="max-height:150px;width:auto;max-width:200px;">
            <div style="margin-left:1em;">
                <h2 class="title is-4" style="margin:0;">{{image.title}}</h2>
                {{tag_list(image.tags)}}
                <br />
                <p class="field">
                    <a class="button is-info">
                        <span class="icon is-small">
                            <i class="fa fa-pencil-alt"> </i>
                        </span>
                        <span> Edit </span>
                    </a>
                    <a class="button is-danger is-outlined" onclick="delete_image('{{image.fileID}}')">
                        <span> Delete </span>
                        <span class="icon is-small">
                            <i class="fa fa-times"> </i>
                        </span>
                    </a>
                </p>
            </div>
        </div>
        <br />
        {% endfor %}
        {% endif %}
        {% endwith %}
    </div>
    <div class="tab" data-tab="dash_settings">
        <h1 class="title">Avatar</h1>
        <p>Your current avatar:</p>
        <img src="/profile/{{user.userID}}/avatar"/>
        <p>If you wish to select a new avatar, you may pick one here:</p>
        <form action="/profile/avatar/upload" method="post" enctype="multipart/form-data">
            <div class="file">
                <label class="file-label">
                    <input class="file-input" type="file" id="avatar" name="avatar">
                    <span class="file-cta">
                        <span class="file-icon">
                            <i class="fas fa-upload"></i>
                        </span>
                        <span class="file-label" id="filename">
                            Select a new avatar
                        </span>
                    </span>
                </label>
            </div>
            <br />
            <button class="button is-success">Update</button>
        </form>
        <script>
            $('#avatar').on('change', function () {
                // output raw value of file input
                $('#filename').html($(this).val().replace(/.*(\/|\\)/, ''));

                // or, manipulate it further with regex etc.
                var filename = $(this).val().replace(/.*(\/|\\)/, '');

                $('#filename').text(filename);
            });
        </script>
    </div>
</div>
{% endblock %}